{% extends 'base.html' %}
{% block title %} Autbot {% endblock %}

{% block content %}
<div id="loading-gif-bg" hidden>
	<img
		src="{{ url_for('static', filename='images/loading cat.gif') }}"
		id="loading-gif"
		class="img-thumbnail">
	<button id="loading-gif-button" class="btn btn-danger" onclick="changeGIF()">
		Mix it up! </button>
</div>

<div id="listening-gif-bg" hidden>
	<img
		src="{{ url_for('static', filename='images/listening.gif') }}"
		id="listening-gif"
		class="img-thumbnail">
</div>

<div id="chat-background" class="container">
	<!-- user mood -->
	<div id="user-emotion" class="{{user_emotion}}">
		<div id="user-emotion-icon">
			{% if user_emotion == "happy" %}
			<i class="fa-regular fa-face-smile-beam fa-2x"></i>
			{% elif user_emotion == "sad" %}
			<i class="fa-regular fa-face-frown fa-2x"></i>
			{% elif user_emotion == "angry" %}
			<i class="fa-regular fa-face-angry fa-2x"></i>
			{% elif user_emotion == "neutral" %}
			<i class="fa-regular fa-face-meh fa-2x"></i>
			{% endif %}
		</div>
		<div id="user-emotion-label">
			<p id="user-emotion-text">You are feeling</p>
			<p id="user-emotion-value">{{user_emotion}}</p>
		</div>
	</div> <!-- end user mood -->

	<!-- messages -->
	<div id="chat-wrapper">
		<div id="chat-message-column-wrapper" class="scroll-bar">
			<div id="chat-message-column" class="static">
				<div id="inactive-check" class="message received" hidden>
					<div class="profile-icon">
						<i class="fa-solid fa-robot"></i>
					</div>
					<div class="content">
						<p class="text">Would you like to talk about something else?</p>
						<audio class="bot-audio" controls src="{{ url_for('static', filename='audio/Inactivity.mp3') }}">
						</audio>
					</div>
				</div>
			</div>
		</div>
	</div> <!-- end chat-wrapper -->

	<div id="message-input-wrapper">
		<!-- user input -->
		<form method="post">
			<div id="user-message-buttons" class="btn-group"
				role="group" aria-label="Submit buttons">

				<button type="submit" id="start-input-button"
					class="btn"
					name="user_input" value="start"
					onclick="setListen()">
					<i class="fa-solid fa-microphone"></i>
					Record Message
				</button>
				<button type="submit" id="stop-input-button"
					class="msger-send-btn btn"
					name="user_input" value="stop"
					onclick="setLoad()">
					<i class="fa-solid fa-microphone-slash"></i>
					Stop Recording
				</button>
			</div>
		</form> <!-- end user message buttons -->
	</div>
</div> <!-- end chat-background -->

{% endblock %}

{% block scripts %}
<script>
	const CHAT_MESSAGE_COLUMN_WRAPPER = document.getElementById('chat-message-column-wrapper'),
		CHAT_MESSAGE_COLUMN = document.getElementById('chat-message-column'),
		STOP_BUTTON = document.getElementById('stop-input-button'),
		MESSAGES = JSON.parse('{{ history | tojson | safe}}'),
		BACK = document.getElementById('background');

	const STATE = {
		isUserSendingMessage: false,
		isChatBotSendingMessage: false,
		currentMood: '{{user_emotion}}',
	};

	function createChatMessage (text, isReceived, img, talk) {
		let message = document.createElement('div'),
			profileIcon = document.createElement('div'),
			icon = document.createElement('i'),
			content = document.createElement('div'),
			contentText1 = document.createElement('p'),
			contentText2 = document.createElement('p'),
			contentImg = document.createElement('img'),
			contentAudio = document.createElement('audio'),
			direction = isReceived ? 'received' : 'sent';

		content.classList.add('content');
		contentText1.classList.add('text');
		contentText2.classList.add('corrected-text');

		content.appendChild(contentText1);

		if (img == true) {
			contentImg.classList.add('bot-img');
			contentImg.classList.add('img-thumbnail');
			contentImg.src = "{{ image_path }}";
			content.appendChild(contentImg);
		}

		if (talk == true) {
			contentAudio.classList.add('bot-audio');
			contentAudio.setAttribute('controls', '');
			contentAudio.setAttribute('autoplay', '');
			contentAudio.src = "{{ response_path }}";
			console.log("{{response_path}}");
			content.appendChild(contentAudio);
		}

		// add profile icon to message
		profileIcon.classList.add('profile-icon');
		profileIcon.appendChild(icon);

		message.classList.add('message');
		message.classList.add(direction);
		BACK.classList.add(STATE.currentMood);

		if (isReceived) {                     // chatbot message
			contentText1.innerHTML = text;
			icon.classList.add('fa-solid');
			icon.classList.add('fa-robot');
			message.classList.add(STATE.currentMood);
			message.appendChild(profileIcon);
			message.appendChild(content);

		} else {                             // user message
			icon.classList.add('fa-solid');
			icon.classList.add('fa-user');
			message.classList.add(STATE.currentMood);
			message.appendChild(content);
			message.appendChild(profileIcon);
			content.appendChild(contentText2);

			// add text to message
			contentText1.innerHTML = text[0];
			contentText2.innerHTML = text[1];
		}
		return message;
	};

	// add message to window
	function addChatMessage (text, isReceived, img, talk) {
		const message = createChatMessage(text, isReceived, img, talk);
		CHAT_MESSAGE_COLUMN.appendChild(message);
	};

	// send message from chatbot
	function sendChatbotMessage (text, img, talk) {
		STATE.isChatBotSendingMessage = true;
		addChatMessage(text, true, img, talk);

		setTimeout(() => {
			STATE.isChatBotSendingMessage = false;
		}, 1000);
	};

	// send message from user
	function sendUserMessage (text) {
		STATE.isUserSendingMessage = true;
		addChatMessage(text, false, false, false);

		setTimeout(() => {
			STATE.isUserSendingMessage = false;
		}, 1000);
	};

	// add all messages to column
	function init () {
		var img = true;
		var talk = true;
		for (var i = 0; i < MESSAGES.length; i++) {
			if (MESSAGES[i].isReceived) {
				sendChatbotMessage(MESSAGES[i].text, img, talk);
			} else {
				sendUserMessage(MESSAGES[i].text);
			}
			img = false;
			talk = false;
		}
		sendChatbotMessage("Hello, I am Autbot. What would you like to talk about today? ðŸ˜„", false);
		changeGIF();
	};

	// listening message
	function setListen() {
		document.getElementById("listening-gif-bg").hidden = false;
	};

	// loading message
	function setLoad() {
		document.getElementById("listening-gif-bg").hidden = true;
		document.getElementById("loading-gif-bg").hidden = false;
	};

	// get random integer between min and max
	function getRndInteger(min, max) {
		return Math.floor(Math.random() * (max - min + 1) ) + min;
	}

	// change loading gif
	function changeGIF() {
		var allGIFs = [
			"{{ url_for('static', filename='images/loading cat.gif') }}",
			"{{ url_for('static', filename='images/loading dog.gif') }}",
			"{{ url_for('static', filename='images/loading elephant.gif') }}",
			"{{ url_for('static', filename='images/loading goat.gif') }}",
			"{{ url_for('static', filename='images/loading tiger.gif') }}"
		];
		var randomGIF = allGIFs[getRndInteger(0, 4)];
		document.getElementById("loading-gif").setAttribute("src", randomGIF);
	};

	// start
	window.onload = init();

	// check for inactivity
	async function checkInactivity() {
		const response = await fetch("/inactivity");
		const jsonData = await response.json();
		const time_diff = jsonData.time_diff;

		if (time_diff >= 45) {
			document.getElementById("inactive-check").hidden = false;
		};
	};
	window.setInterval(checkInactivity, 5000);

</script>
{% endblock %}
